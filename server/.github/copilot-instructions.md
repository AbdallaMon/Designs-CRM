## Server AI Guide

- **Stack**: Node 18+ ESM, Express (`index.js`), Prisma + MySQL (`prisma/schema.prisma`), BullMQ + Redis (`services/queues/*`, `services/workers/*`), Socket.IO (`services/socket.js`), Telegram client (`services/telegram/*`).
- **HTTP layout**: `routes/**` map 1:1 to domain services in `services/main/**`; keep business logic in services, routes thin and async; reuse helpers from `services/main/utility/utility.js` for auth, pagination, multer uploads, FTP, and Prisma error mapping.
- **Auth**: JWT stored in `token` cookie. Use `verifyTokenAndHandleAuthorization` for role checks; it auto-refreshes nearly expired tokens and writes a new cookie (secure + SameSite=None). For public endpoints avoid that middleware and use `verifyTokenUsingReq`/`verifyToken` as needed.
- **CORS/origins**: `allowedOrigins` built from `ORIGIN`, `OLDORIGIN`, `COURSESORIGIN`, `PORTFOLIOORIGIN`; disallowed origins throw. Static `/uploads` served from `E:/home/...` only when `ISLOCAL` is set.
- **DB**: Prisma client wrapper in `prisma/prisma.js` (singleton in dev). `schema.prisma` is large; keep generator/datasource/enums comment intact. Migrations live in `prisma/migrations/**`. Use Prisma include/select carefully to avoid overfetching large relations.
- **Services patterns**: Services often return `{ data, message }` or raw models; routes translate to HTTP. Pagination via `getPagination(req)`; Prisma errors go through `handlePrismaError`. When creating files/resources, prefer existing helpers rather than duplicating query logic.
- **Telegram flows**: Client in `services/telegram/connectToTelegram.js` (needs `TELE_API_ID`, `TELE_API_HASH`, `TELEGRAM_SESSION`). Channel/user ops live in `services/telegram/telegram-functions.js`, which also enqueues BullMQ jobs (`telegram*Queue.js`) and persists channel/link metadata to Prisma. Cron dispatcher is `tele-cron.js`; run it separately.
- **Queues/workers**: Queue config at `services/queues/*.js`, connection `services/redis/bullmqConnection.js` (localhost:6379). Workers in `services/workers/*.js` consume queues; `start-telegram-system.js` imports all workers to boot them. Jobs often use deterministic `jobId` to prevent duplicatesâ€”preserve when adding new jobs.
- **Realtime**: Socket.IO initiated in `services/socket.js` using shared `allowedOrigins`; connection requires `userId` query and updates `user.lastSeenAt`. Use `getIo()` from services for emitting events; it throws if socket not initialized.
- **Email**: `services/sendMail.js` uses SMTP creds (`SMTP_HOST`, `EMAIL_USERNAME`, `EMAIL_PASSWORD`, optional `AHMED_EMAIL`) and company names from `services/constants.js`. Pass `isClient=true` to send from client mailbox.
- **File/storage**: Upload helpers in `utility.js` (FTP via `basic-ftp`, `uploadToFTPHttpAsBuffer`). Client image-session PDFs generated in `services/main/client/clientServices.js` using custom fonts under `services/fonts`. Public URLs usually `https://panel.dreamstudiio.com/uploads/<file>`.
- **Start commands**: API `node index.js`; workers `node start-telegram-system.js`; Telegram cron dispatcher `node tele-cron.js`; generate Telegram session `node tele.js`. Post-install expects DB ready: `npx prisma migrate deploy && node initData.js` (initData.js must exist alongside package.json if used).
- **Env essentials**: `DATABASE_URL`, `SECRET_KEY`, origins (`ORIGIN`, `OLDORIGIN`, `COURSESORIGIN`, `PORTFOLIOORIGIN`), `ISLOCAL`, SMTP vars, Telegram vars above, Stripe keys if payments touched. Redis assumed at 127.0.0.1:6379 unless overridden in `bullmqConnection.js`.
- **Conventions**: Keep modules ESM with explicit extensions. Favor domain folders in `services/main` and wire them via matching routers. For long jobs (PDF, Telegram), prefer BullMQ queues instead of blocking HTTP. When adding Prisma models, ensure enums/indexes align with existing status/role names.
- **Testing/validation**: No formal test suite; verify critical flows manually: login sets `token` cookie, protected routes enforce role, queues start without connection errors, Prisma migrations applied.

Ask the team if new sections are unclear or if more workflow commands should be captured.
