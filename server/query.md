ALTER TABLE User MODIFY COLUMN role ENUM(
'ADMIN',
'STAFF',
'THREE_D_DESIGNER',
'TWO_D_DESIGNER',
'ACCOUNTANT',
'SUPER_ADMIN'
) NOT NULL DEFAULT 'STAFF';

CREATE TABLE UserLog (
id INT AUTO_INCREMENT PRIMARY KEY,
userId INT NOT NULL,
signInAt DATETIME NOT NULL,
signOutAt DATETIME NULL,
totalHours DECIMAL(5,2) NULL,
FOREIGN KEY (userId) REFERENCES User(id) ON DELETE CASCADE,
INDEX (userId)
);

ALTER TABLE User ADD COLUMN hasLogs BOOLEAN DEFAULT FALSE;

ALTER TABLE ClientLead
ADD COLUMN threeDWorkStage ENUM(
'CLIENT_COMMUNICATION',
'DESIGN_STAGE',
'THREE_D_STAGE',
'THREE_D_APPROVAL'
) NULL,
ADD COLUMN twoDWorkStage ENUM(
'DRAWING_PLAN',
'FINAL_DELIVERY'
) NULL;

ALTER TABLE ClientLead
ADD COLUMN threeDDesignerId INT NULL,
ADD COLUMN twoDDesignerId INT NULL,
ADD COLUMN accountantId INT NULL,
ADD CONSTRAINT fk_threeDDesigner FOREIGN KEY (threeDDesignerId) REFERENCES User(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_twoDDesigner FOREIGN KEY (twoDDesignerId) REFERENCES User(id) ON DELETE SET NULL,
ADD CONSTRAINT fk_accountant FOREIGN KEY (accountantId) REFERENCES User(id) ON DELETE SET NULL;

CREATE TABLE ExtraService (
id INT AUTO_INCREMENT PRIMARY KEY,
clientLeadId INT NOT NULL,
price DECIMAL(10,2) NOT NULL,
note TEXT NULL,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (clientLeadId) REFERENCES ClientLead(id) ON DELETE CASCADE
);

ALTER TABLE ClientLead
ADD COLUMN paymentStatus ENUM(
'PENDING',
'PARTIALLY_PAID',
'FULLY_PAID'
) DEFAULT 'PENDING';

CREATE TABLE Payment (
id INT AUTO_INCREMENT PRIMARY KEY,
clientLeadId INT NOT NULL,
status ENUM('PENDING', 'PARTIALLY_PAID', 'FULLY_PAID') DEFAULT 'PENDING',
amount DECIMAL(10,2) NOT NULL,
amountPaid DECIMAL(10,2) DEFAULT 0,
amountLeft DECIMAL(10,2) NOT NULL,
dueDate DATETIME NOT NULL,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
FOREIGN KEY (clientLeadId) REFERENCES ClientLead(id) ON DELETE CASCADE
);

CREATE TABLE Invoice (
id INT AUTO_INCREMENT PRIMARY KEY,
paymentId INT NOT NULL,
issuedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
amount DECIMAL(10,2) NOT NULL,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (paymentId) REFERENCES Payment(id) ON DELETE CASCADE
);

ALTER TABLE Notification
MODIFY COLUMN type ENUM(
'NEW_LEAD',
'LEAD_ASSIGNED',
'LEAD_STATUS_CHANGE',
'LEAD_TRANSFERRED',
'LEAD_UPDATED',
'LEAD_CONTACT',
'NOTE_ADDED',
'NEW_NOTE',
'NEW_FILE',
'CALL_REMINDER_CREATED',
'CALL_REMINDER_STATUS',
'PRICE_OFFER_SUBMITTED',
'PRICE_OFFER_UPDATED',
'FINAL_PRICE_ADDED',
'FINAL_PRICE_CHANGED',
'PAYMENT_ADDED', -- New payment recorded
'PAYMENT_STATUS_UPDATED', -- Payment status updated
'EXTRA_FINAL_PRICE_ADDED', -- Extra final price added
'EXTRA_FINAL_PRICE_EDITED', -- Extra final price edited
'WORK_STAGE_UPDATED', -- Work stage updated for 3D or 2D
'OTHER'
) NOT NULL;

ALTER TABLE Payment
ADD COLUMN paymentReason TEXT NULL;

ALTER TABLE ClientLead
ADD COLUMN threeDAssignedAt DATETIME NULL,
ADD COLUMN twoDAssignedAt DATETIME NULL,
ADD COLUMN accountantAssignedAt DATETIME NULL;

ALTER TABLE Invoice
ADD CONSTRAINT fk_payment_id
FOREIGN KEY (paymentId) REFERENCES Payment(id)
ON DELETE CASCADE;
