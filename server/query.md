CREATE TABLE Course (
id INT AUTO_INCREMENT PRIMARY KEY,
title VARCHAR(255) NOT NULL,
description TEXT,
imageUrl TEXT,
isPublished BOOLEAN DEFAULT FALSE,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE CourseRole (
id INT AUTO_INCREMENT PRIMARY KEY,
courseId INT NOT NULL,
role ENUM('ADMIN', 'STUDENT', 'TEACHER') NOT NULL,
FOREIGN KEY (courseId) REFERENCES Course(id)
);

CREATE TABLE Lesson (
id INT AUTO_INCREMENT PRIMARY KEY,
courseId INT NOT NULL,
title VARCHAR(255) NOT NULL,
description TEXT,
duration INT,
`order` INT DEFAULT 0,
isPreviewable BOOLEAN DEFAULT FALSE,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
UNIQUE KEY uniq_course_order (courseId, `order`),
FOREIGN KEY (courseId) REFERENCES Course(id)
);

CREATE TABLE Test (
id INT AUTO_INCREMENT PRIMARY KEY,
title VARCHAR(255),
type ENUM('LESSON', 'FINAL', 'PRACTICE', 'PLACEMENT') DEFAULT 'LESSON',
courseId INT,
lessonId INT,
attemptLimit INT DEFAULT 2,
certificateApprovedByAdmin BOOLEAN DEFAULT FALSE,
FOREIGN KEY (courseId) REFERENCES Course(id),
FOREIGN KEY (lessonId) REFERENCES Lesson(id)
);

CREATE TABLE LessonVideo (
id INT AUTO_INCREMENT PRIMARY KEY,
lessonId INT NOT NULL,
url LONGTEXT NOT NULL,
videoType ENUM('IFRAME', 'URL') DEFAULT 'IFRAME',
FOREIGN KEY (lessonId) REFERENCES Lesson(id)
);

CREATE TABLE LessonPDF (
id INT AUTO_INCREMENT PRIMARY KEY,
lessonId INT NOT NULL,
url LONGTEXT NOT NULL,
FOREIGN KEY (lessonId) REFERENCES Lesson(id)
);
CREATE TABLE LessonLink (
id INT AUTO_INCREMENT PRIMARY KEY,
lessonId INT NOT NULL,
url LONGTEXT NOT NULL,
title VARCHAR(255) NOT NULL,
FOREIGN KEY (lessonId) REFERENCES Lesson(id)
);

CREATE TABLE TestQuestion (
id INT AUTO_INCREMENT PRIMARY KEY,
testId INT NOT NULL,
type ENUM('MULTIPLE_CHOICE', 'SINGLE_CHOICE', 'TRUE_FALSE', 'TEXT') NOT NULL,
question TEXT NOT NULL,
FOREIGN KEY (testId) REFERENCES Test(id)
);

CREATE TABLE TestChoice (
id INT AUTO_INCREMENT PRIMARY KEY,
questionId INT NOT NULL,
text VARCHAR(255) NOT NULL,
value VARCHAR(255) NOT NULL,
isCorrect BOOLEAN DEFAULT FALSE,
FOREIGN KEY (questionId) REFERENCES TestQuestion(id)
);

CREATE TABLE TestAttempt (
id INT AUTO_INCREMENT PRIMARY KEY,
testId INT NOT NULL,
userId INT NOT NULL,
score FLOAT,
passed BOOLEAN DEFAULT FALSE,
attemptCount INT DEFAULT 0,
attemptLimit INT DEFAULT 2,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
FOREIGN KEY (testId) REFERENCES Test(id),
FOREIGN KEY (userId) REFERENCES User(id)
);

CREATE TABLE UserAnswer (
id INT AUTO_INCREMENT PRIMARY KEY,
attemptId INT NOT NULL,
questionId INT NOT NULL,
textAnswer TEXT,
FOREIGN KEY (attemptId) REFERENCES TestAttempt(id),
FOREIGN KEY (questionId) REFERENCES TestQuestion(id)
);

CREATE TABLE SelectedAnswer (
id INT AUTO_INCREMENT PRIMARY KEY,
userAnswerId INT NOT NULL,
value VARCHAR(255) NOT NULL,
FOREIGN KEY (userAnswerId) REFERENCES UserAnswer(id)
);

CREATE TABLE CourseProgress (
id INT AUTO_INCREMENT PRIMARY KEY,
userId INT NOT NULL,
courseId INT NOT NULL,
updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (userId) REFERENCES User(id),
FOREIGN KEY (courseId) REFERENCES Course(id)
);

CREATE TABLE CompletedLesson (
id INT AUTO_INCREMENT PRIMARY KEY,
courseProgressId INT NOT NULL,
lessonId INT NOT NULL,
completedAt DATETIME DEFAULT CURRENT_TIMESTAMP,
FOREIGN KEY (courseProgressId) REFERENCES CourseProgress(id)
);

CREATE TABLE Certificate (
id INT AUTO_INCREMENT PRIMARY KEY,
userId INT NOT NULL,
courseId INT NOT NULL,
isApproved BOOLEAN DEFAULT FALSE,
createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
fileUrl TEXT,
FOREIGN KEY (userId) REFERENCES User(id),
FOREIGN KEY (courseId) REFERENCES Course(id)
);
